<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://static.line-scdn.net https://kit.fontawesome.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://kit.fontawesome.com; font-src https://fonts.gstatic.com https://kit.fontawesome.com; connect-src 'self' https://zipcloud.ibsnet.co.jp https://api.line.me; img-src 'self' data: https:; frame-ancestors 'none';" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <title>ã”æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    /* ===============================
       Calm & Elegant Theme with Security Enhancements
       =============================== */

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
      /* Base neutrals */
      --bg: #f6f6f6;
      --panel: #ffffff;
      --ink-900: #111827;
      --ink-700: #374151;
      --ink-500: #6b7280;
      --line: #e5e7eb;

      /* Accent */
      --accent-50: #fffbfc;
      --accent-100: #ffefef;
      --accent-200: #ffdddd;
      --accent-300: #f6c8c8;
      --accent-500: #df9b9b;
      --accent-600: #c57f7f;

      /* Security colors */
      --security-green: #10b981;
      --security-yellow: #f59e0b;
      --security-red: #ef4444;

      /* Shadows */
      --shadow: 0 2px 10px rgba(17, 24, 39, 0.06);
      --shadow-lg: 0 8px 28px rgba(17, 24, 39, 0.08);

      /* Radii */
      --r-md: 12px;
      --r-lg: 16px;

      /* Motion */
      --ease: cubic-bezier(.2,.7,.2,1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
      color: var(--ink-900);
      background: linear-gradient(180deg, var(--bg) 0%, #ffffff 100%);
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 32px 16px;
      display: grid;
      place-items: start center;
    }

    .container {
      width: min(720px, 100%);
      background: var(--panel);
      border: 1px solid var(--line);
      box-shadow: var(--shadow-lg);
      border-radius: var(--r-lg);
      padding: clamp(20px, 3vw, 32px);
      position: relative;
    }

    .container::before {
      content: "";
      position: absolute; inset: 0 0 auto 0; height: 6px;
      background: linear-gradient(90deg, var(--accent-200), var(--accent-300));
      border-radius: var(--r-lg) var(--r-lg) 0 0;
    }

    /* Security status indicator */
    .security-indicator {
      position: fixed;
      top: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--line);
      border-radius: var(--r-md);
      font-size: 12px;
      font-weight: 600;
      box-shadow: var(--shadow);
      z-index: 100;
    }

    .security-indicator.secure {
      color: var(--security-green);
      border-color: var(--security-green);
      background: rgba(16, 185, 129, 0.05);
    }

    .security-indicator.warning {
      color: var(--security-yellow);
      border-color: var(--security-yellow);
      background: rgba(245, 158, 11, 0.05);
    }

    h1 {
      margin: 8px 0 20px;
      font-size: clamp(22px, 3.2vw, 28px);
      font-weight: 700;
      letter-spacing: .01em;
      color: var(--ink-700);
    }

    .section-header {
      display: block;
      margin: 28px 0 12px;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 15px;
      color: var(--ink-700);
      background: linear-gradient(180deg, var(--accent-100), #fff);
      border: 1px solid var(--accent-200);
      border-radius: var(--r-md);
    }

    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      font-size: 12px; font-weight: 600;
      padding: 4px 10px; border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--ink-700);
      background: #fff;
      margin-right: 8px;
    }
    .chip.required { border-color: #ef4444; color: #ef4444; background: #fff5f5; }
    .chip.optional { color: var(--ink-500); }

    .info-text {
      margin: 8px 0 16px;
      padding: 12px 14px;
      background: var(--accent-50);
      border: 1px dashed var(--accent-200);
      border-radius: var(--r-md);
      color: var(--ink-700);
      font-size: 14px;
    }

    .security-notice {
      margin: 8px 0 16px;
      padding: 12px 14px;
      background: rgba(16, 185, 129, 0.05);
      border: 1px solid var(--security-green);
      border-radius: var(--r-md);
      color: var(--ink-700);
      font-size: 13px;
    }

    label.label {
      display: block;
      margin: 18px 0 8px;
      font-weight: 600;
      color: var(--ink-700);
      font-size: 14px;
    }

    input[type="text"], input[type="tel"], textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--line);
      border-radius: var(--r-md);
      font-size: 16px;
      background: #fff;
      color: var(--ink-900);
      transition: border-color .2s var(--ease), box-shadow .2s var(--ease);
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-500);
      box-shadow: 0 0 0 4px rgba(223, 155, 155, .18);
    }

    .grid-buttons {
      display: grid; gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      margin: 10px 0 14px;
    }

    .btn-option {
      appearance: none; cursor: pointer;
      padding: 12px 14px; min-height: 44px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: var(--r-md);
      font-size: 14px; font-weight: 600; color: var(--ink-700);
      display: inline-flex; align-items: center; justify-content: center; text-align: center;
      transition: transform .05s var(--ease), border-color .2s var(--ease), background .2s var(--ease), box-shadow .2s var(--ease);
    }
    .btn-option:hover { border-color: var(--accent-300); background: var(--accent-50); }
    .btn-option:active { transform: translateY(1px); }
    .btn-option.active { border-color: var(--accent-500); background: var(--accent-100); box-shadow: inset 0 0 0 1px var(--accent-500); }

    .postal-input-container { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }

    .btn-accent {
      appearance: none; cursor: pointer;
      padding: 12px 16px; min-height: 44px; width: 100%;
      border: 1px solid var(--accent-500);
      background: linear-gradient(180deg, var(--accent-500), var(--accent-600));
      color: #fff; font-weight: 700; font-size: 16px;
      border-radius: var(--r-lg);
      box-shadow: var(--shadow);
      transition: transform .06s var(--ease), filter .2s var(--ease);
    }
    .btn-accent:hover { filter: brightness(1.02); }
    .btn-accent:active { transform: translateY(1px); }
    .btn-accent:disabled { opacity: .55; cursor: not-allowed; }

    .btn-subtle {
      appearance: none; cursor: pointer;
      padding: 12px 14px; min-height: 44px;
      border: 1px solid var(--line);
      background: #fff; color: var(--ink-700);
      border-radius: var(--r-md);
      font-weight: 600; font-size: 14px;
      transition: border-color .2s var(--ease), background .2s var(--ease);
    }
    .btn-subtle:hover { background: var(--accent-50); border-color: var(--accent-300); }

    .side-nav {
      position: fixed; right: 12px; top: 50%; transform: translateY(-50%);
      background: #fff; border: 1px solid var(--line); border-radius: 14px; padding: 8px;
      box-shadow: var(--shadow);
    }
    .side-nav a { display: grid; place-items: center; width: 44px; height: 44px; text-decoration: none; color: var(--ink-700); border-radius: 10px; font-size: 18px; }
    .side-nav a:hover { background: var(--accent-100); }

    .error-message { color: #b91c1c; font-size: 13px; margin-top: 6px; }

    .clear-data-btn {
      appearance: none; cursor: pointer;
      padding: 8px 12px; margin: 16px 0;
      border: 1px solid #dc2626;
      background: #fff; color: #dc2626;
      border-radius: var(--r-md);
      font-weight: 600; font-size: 13px;
      transition: background .2s var(--ease);
    }
    .clear-data-btn:hover { background: #fef2f2; }

    /* Validation styles */
    .field-valid { border-color: var(--security-green) !important; }
    .field-invalid { border-color: var(--security-red) !important; }

    /* Rate limiting indicator */
    .rate-limit-notice {
      margin: 8px 0 16px;
      padding: 8px 12px;
      background: rgba(245, 158, 11, 0.05);
      border: 1px solid var(--security-yellow);
      border-radius: var(--r-md);
      color: var(--ink-700);
      font-size: 12px;
      display: none;
    }

    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) { * { transition: none !important; } }

    @media (max-width: 768px) {
      body { padding: 20px 12px; }
      .container { padding: 20px; }
      .side-nav { right: 8px; }
      .side-nav a { width: 40px; height: 40px; }
      .security-indicator { top: 12px; right: 12px; }
    }

    @media (max-width: 640px) {
      html, body { font-size: 16px; }
      body { padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) calc(84px + env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); }
      .container { border-radius: 14px; padding: 16px; }
      .grid-buttons { grid-template-columns: 1fr; }
      .side-nav { display: none; }
    }

    /* Bottom fixed submit bar */
    .footer-cta {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
      background: rgba(255,255,255,.85);
      backdrop-filter: saturate(140%) blur(10px);
      border-top: 1px solid var(--line);
      box-shadow: 0 -6px 24px rgba(17,24,39,.06);
      z-index: 50;
    }
    .footer-cta .btn-accent { width: 100%; }

    /* Touch adjustments */
    * { -webkit-tap-highlight-color: transparent; }
    .btn-option, .btn-subtle, .btn-accent { touch-action: manipulation; }

    .container::after {
        content: "";
        display: block;
        height: 140px;
    }

  </style>
</head>

<body>
  <nav class="side-nav" aria-label="ãƒšãƒ¼ã‚¸å†…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
    <a href="#section-message" title="é€ä¿¡ã¸ç§»å‹•"><span aria-hidden>â‡©</span></a>
  </nav>

  <main class="container" role="main">
    <h1>ã”æ³¨æ–‡ãƒšãƒ¼ã‚¸</h1>

    <!-- ãŠåå‰ -->
    <div class="section-header"><span class="chip required">å¿…é ˆ</span>ãŠåå‰ã‚’ãŠé¡˜ã„ã—ã¾ã™</div>
    <p class="info-text">ãŠæ‰‹æ•°ã§ã™ãŒãŠåå‰ã®è¨˜è¼‰ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚</p>
    <label class="label" for="lastName">å§“</label>
    <input type="text" id="lastName" placeholder="å§“" autocomplete="family-name" maxlength="50" />
    <div class="error-message" id="lastNameError" style="display:none;"></div>
    
    <label class="label" for="firstName">å</label>
    <input type="text" id="firstName" placeholder="å" autocomplete="given-name" maxlength="50" />
    <div class="error-message" id="firstNameError" style="display:none;"></div>

    <!-- ã”æ³¨æ–‡å†…å®¹ -->
    <div class="section-header"><span class="chip optional">ä»»æ„</span>ã”æ³¨æ–‡ã®å•†å“ã‚’ã”è¨˜å…¥ãã ã•ã„</div>
    <p class="info-text">ãƒ»å•†å“åã€è‰²ç•ªå·<br />ãƒ»æ•°é‡<br />ãƒ»ãã®ä»–ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ä½•ã§ã‚‚ã©ã†ã</p>
    <label class="label" for="orderDetails">ã”æ³¨æ–‡å†…å®¹</label>
    <textarea id="orderDetails" rows="4" placeholder="ã”æ³¨æ–‡å†…å®¹ã‚’ã”è¨˜å…¥ãã ã•ã„" maxlength="1000"></textarea>

    <!-- æ”¯æ‰•ã„æ–¹æ³• -->
    <div class="section-header"><span class="chip required">å¿…é ˆ</span>ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="grid-buttons" role="group" aria-label="ãŠæ”¯æ‰•ã„æ–¹æ³•">
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">paypay</button>
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">éŠ€è¡ŒæŒ¯è¾¼</button>
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</button>
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">åº—é ­æ”¯æ‰•</button>
    </div>

    <!-- ãŠå±Šã‘æ–¹æ³• -->
    <div class="section-header"><span class="chip required">å¿…é ˆ</span>ãŠå±Šã‘æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    <div class="grid-buttons" role="group" aria-label="ãŠå±Šã‘æ–¹æ³•">
      <button type="button" class="btn-option two" onclick="selectDelivery(this)" aria-pressed="false">å®…é…ï¼ˆé€æ–™ç„¡æ–™ï¼‰</button>
      <button type="button" class="btn-option two" onclick="selectDelivery(this)" aria-pressed="false">åº—é ­å—ã‘å–ã‚Š</button>
    </div>

    <!-- é€£çµ¡å…ˆãƒ»ä½æ‰€æƒ…å ± -->
    <label class="label"><span class="chip required">å¿…é ˆ</span>ãŠé›»è©±ç•ªå·</label>
    <p class="info-text">æ—¥ä¸­ã«ã”é€£çµ¡ãŒã¤ãç•ªå·ã‚’ã”è¨˜å…¥ãã ã•ã„ã€‚</p>
    <input type="tel" id="phone" inputmode="tel" autocomplete="tel" placeholder="09012345678ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰" maxlength="15">
    <div class="error-message" id="phoneError" style="display:none;"></div>

    <label class="label"><span class="chip required">å¿…é ˆ</span>ãŠå±Šã‘å…ˆä½æ‰€</label>

    <label class="label" for="postalCode">éƒµä¾¿ç•ªå·</label>
    <div class="postal-input-container">
      <input type="text" id="postalCode" inputmode="numeric" pattern="\d{7}" placeholder="ä¾‹: 1000001ï¼ˆ7æ¡ãƒ»ãƒã‚¤ãƒ•ãƒ³ä¸è¦ï¼‰" maxlength="7">
      <button type="button" class="btn-subtle" onclick="searchAddress()" id="searchBtn">ä½æ‰€æ¤œç´¢</button>
    </div>
    <div class="error-message" id="postalError" style="display:none;"></div>
    <div class="rate-limit-notice" id="rateLimitNotice">
      ä½æ‰€æ¤œç´¢ã®åˆ©ç”¨å›æ•°ãŒä¸Šé™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚
    </div>

    <label class="label" for="prefecture">éƒ½é“åºœçœŒ</label>
    <input type="text" id="prefecture" placeholder="éƒ½é“åºœçœŒ" readonly maxlength="10" />

    <label class="label" for="city">å¸‚åŒºç”ºæ‘</label>
    <input type="text" id="city" placeholder="å¸‚åŒºç”ºæ‘" readonly maxlength="50" />

    <label class="label" for="address">ç•ªåœ°</label>
    <input type="text" id="address" placeholder="ç•ªåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" maxlength="100" />
    <div class="error-message" id="addressError" style="display:none;"></div>

    <label class="label" for="building">ãƒãƒ³ã‚·ãƒ§ãƒ³ãƒ»ãƒ“ãƒ«åï¼ˆä»»æ„ï¼‰</label>
    <input type="text" id="building" placeholder="ãƒãƒ³ã‚·ãƒ§ãƒ³ãƒ»ãƒ“ãƒ«åï¼ˆä»»æ„ï¼‰" maxlength="100" />

    <!-- ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ -->
    <button type="button" class="clear-data-btn" onclick="clearAllSavedData()">ä¿å­˜æ¸ˆã¿å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>

    <div style="margin-top: 20px;"></div>
  </main>

  <!-- ç”»é¢ä¸‹éƒ¨ã«å›ºå®šã®é€ä¿¡ãƒãƒ¼ -->
  <div class="footer-cta">
    <button class="btn-accent" onclick="submitForm()" id="section-message">é€ä¿¡</button>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let paymentMethod = '';
    let deliveryMethod = '';
    let addressSearchCount = 0;
    const MAX_ADDRESS_SEARCHES = 10; // ä½æ‰€æ¤œç´¢ã®ä¸Šé™
    let lastAddressSearchTime = 0;
    const SEARCH_COOLDOWN = 2000; // 2ç§’ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

    // æš—å·åŒ–ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚­ãƒ¼ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã‚’ä½¿ç”¨ï¼‰
    const ENCRYPTION_KEY = 'orderForm2024secure';

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
    const STORAGE_KEYS = {
      name: 'secureOrderForm:name:encrypted',
      phone: 'secureOrderForm:phone:encrypted',
      address: 'secureOrderForm:address:encrypted',
      searchCount: 'secureOrderForm:searchCount'
    };

    // ã‚·ãƒ³ãƒ—ãƒ«ãªXORæš—å·åŒ–ï¼ˆãƒ‡ãƒ¢ç”¨é€”ï¼‰
    function simpleEncrypt(text, key) {
      try {
        const encrypted = [];
        for (let i = 0; i < text.length; i++) {
          encrypted.push(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return btoa(encrypted.join(','));
      } catch (e) {
        console.error('Encryption failed:', e);
        return null;
      }
    }

    function simpleDecrypt(encrypted, key) {
      try {
        const decrypted = [];
        const data = atob(encrypted).split(',');
        for (let i = 0; i < data.length; i++) {
          decrypted.push(String.fromCharCode(data[i] ^ key.charCodeAt(i % key.length)));
        }
        return decrypted.join('');
      } catch (e) {
        console.error('Decryption failed:', e);
        return null;
      }
    }

    // å…¥åŠ›å€¤ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input
        .replace(/[<>\"'&]/g, '') // XSSå¯¾ç­–
        .replace(/[\x00-\x1f\x7f-\x9f]/g, '') // åˆ¶å¾¡æ–‡å­—é™¤å»
        .trim();
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
    function validateName(name) {
      const sanitized = sanitizeInput(name);
      if (!sanitized || sanitized.length === 0) {
        return { isValid: false, message: 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      }
      if (sanitized.length > 50) {
        return { isValid: false, message: 'åå‰ã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      }
      if (!/^[ã-ã‚“ ã‚¡-ãƒ¶a-zA-Zä¸€-é¾¯]+$/.test(sanitized)) {
        return { isValid: false, message: 'æœ‰åŠ¹ãªåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      }
      return { isValid: true, value: sanitized };
    }

    function validatePhone(phone) {
      const sanitized = sanitizeInput(phone).replace(/[^\d]/g, '');
      if (!sanitized || sanitized.length === 0) {
        return { isValid: false, message: 'é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      }
      if (!/^0\d{9,10}$/.test(sanitized)) {
        return { isValid: false, message: 'æœ‰åŠ¹ãªé›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 09012345678ï¼‰ã€‚' };
      }
      return { isValid: true, value: sanitized };
    }

    function validateAddress(address) {
      const sanitized = sanitizeInput(address);
      if (!sanitized || sanitized.length === 0) {
        return { isValid: false, message: 'ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      }
      if (sanitized.length > 100) {
        return { isValid: false, message: 'ä½æ‰€ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      }
      return { isValid: true, value: sanitized };
    }

    // ã‚»ã‚­ãƒ¥ã‚¢ãªä¿å­˜é–¢æ•°
    function saveNameToStorage() {
      try {
        const lastNameValidation = validateName(document.getElementById('lastName').value);
        const firstNameValidation = validateName(document.getElementById('firstName').value);

        showFieldValidation('lastName', lastNameValidation);
        showFieldValidation('firstName', firstNameValidation);

        if (!lastNameValidation.isValid || !firstNameValidation.isValid) {
          return;
        }

        const data = JSON.stringify({
          lastName: lastNameValidation.value,
          firstName: firstNameValidation.value,
          savedAt: Date.now()
        });

        const encrypted = simpleEncrypt(data, ENCRYPTION_KEY);
        if (encrypted) {
          sessionStorage.setItem(STORAGE_KEYS.name, encrypted);
        }
      } catch (e) {
        console.error('Name save failed:', e);
      }
    }

    function savePhoneToStorage() {
      try {
        const phoneValidation = validatePhone(document.getElementById('phone').value);
        showFieldValidation('phone', phoneValidation);

        if (!phoneValidation.isValid) {
          return;
        }

        const encrypted = simpleEncrypt(phoneValidation.value, ENCRYPTION_KEY);
        if (encrypted) {
          sessionStorage.setItem(STORAGE_KEYS.phone, encrypted);
        }
      } catch (e) {
        console.error('Phone save failed:', e);
      }
    }

    function saveAddressToStorage() {
      try {
        const addressValidation = validateAddress(document.getElementById('address').value);
        showFieldValidation('address', addressValidation);

        const addressData = {
          postalCode: sanitizeInput(document.getElementById('postalCode').value),
          prefecture: sanitizeInput(document.getElementById('prefecture').value),
          city: sanitizeInput(document.getElementById('city').value),
          address: addressValidation.isValid ? addressValidation.value : '',
          building: sanitizeInput(document.getElementById('building').value),
          savedAt: Date.now()
        };

        if (!addressData.postalCode && !addressData.prefecture && !addressData.city && 
            !addressData.address && !addressData.building) {
          sessionStorage.removeItem(STORAGE_KEYS.address);
          return;
        }

        const data = JSON.stringify(addressData);
        const encrypted = simpleEncrypt(data, ENCRYPTION_KEY);
        if (encrypted) {
          sessionStorage.setItem(STORAGE_KEYS.address, encrypted);
        }
      } catch (e) {
        console.error('Address save failed:', e);
      }
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è¡¨ç¤º
    function showFieldValidation(fieldId, validation) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + 'Error');

      if (!field || !errorDiv) return;

      if (validation.isValid) {
        field.classList.remove('field-invalid');
        field.classList.add('field-valid');
        errorDiv.style.display = 'none';
      } else {
        field.classList.remove('field-valid');
        field.classList.add('field-invalid');
        errorDiv.textContent = validation.message;
        errorDiv.style.display = 'block';
      }
    }

    // ã‚»ã‚­ãƒ¥ã‚¢ãªèª­ã¿è¾¼ã¿é–¢æ•°
    function loadNameFromStorage() {
      try {
        const encrypted = sessionStorage.getItem(STORAGE_KEYS.name);
        if (!encrypted) return;

        const decrypted = simpleDecrypt(encrypted, ENCRYPTION_KEY);
        if (!decrypted) return;

        const data = JSON.parse(decrypted);
        if (data.lastName) document.getElementById('lastName').value = data.lastName;
        if (data.firstName) document.getElementById('firstName').value = data.firstName;
      } catch (e) {
        console.warn('Name load failed:', e);
        sessionStorage.removeItem(STORAGE_KEYS.name);
      }
    }

    function loadPhoneFromStorage() {
      try {
        const encrypted = sessionStorage.getItem(STORAGE_KEYS.phone);
        if (!encrypted) return;

        const decrypted = simpleDecrypt(encrypted, ENCRYPTION_KEY);
        if (decrypted) {
          document.getElementById('phone').value = decrypted;
        }
      } catch (e) {
        console.warn('Phone load failed:', e);
        sessionStorage.removeItem(STORAGE_KEYS.phone);
      }
    }

    function loadAddressFromStorage() {
      try {
        const encrypted = sessionStorage.getItem(STORAGE_KEYS.address);
        if (!encrypted) return;

        const decrypted = simpleDecrypt(encrypted, ENCRYPTION_KEY);
        if (!decrypted) return;

        const addressData = JSON.parse(decrypted);
        
        if (addressData.postalCode) document.getElementById('postalCode').value = addressData.postalCode;
        if (addressData.prefecture) document.getElementById('prefecture').value = addressData.prefecture;
        if (addressData.city) document.getElementById('city').value = addressData.city;
        if (addressData.address) document.getElementById('address').value = addressData.address;
        if (addressData.building) document.getElementById('building').value = addressData.building;
      } catch (e) {
        console.warn('Address load failed:', e);
        sessionStorage.removeItem(STORAGE_KEYS.address);
      }
    }

    // ä¿å­˜ã•ã‚ŒãŸã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
    function clearAllSavedData() {
      if (confirm('ä¿å­˜ã•ã‚ŒãŸå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®å…¥åŠ›å†…å®¹ã¯æ®‹ã‚Šã¾ã™ï¼‰')) {
        try {
          Object.values(STORAGE_KEYS).forEach(key => {
            sessionStorage.removeItem(key);
            localStorage.removeItem(key); // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
          });
          alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
        } catch (e) {
          console.warn('ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
          alert('ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      }
    }

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    function checkRateLimit() {
      const now = Date.now();
      if (now - lastAddressSearchTime < SEARCH_COOLDOWN) {
        return false;
      }

      const storedCount = parseInt(sessionStorage.getItem(STORAGE_KEYS.searchCount) || '0');
      if (storedCount >= MAX_ADDRESS_SEARCHES) {
        document.getElementById('rateLimitNotice').style.display = 'block';
        return false;
      }

      return true;
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸä½æ‰€æ¤œç´¢
    async function searchAddress() {
      const postal = sanitizeInput(document.getElementById('postalCode').value).replace(/[^\d]/g, '');
      const errorDiv = document.getElementById('postalError');
      const btn = document.getElementById('searchBtn');

      errorDiv.style.display = 'none';
      document.getElementById('rateLimitNotice').style.display = 'none';

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (postal.length !== 7) {
        errorDiv.textContent = '7æ¡ã®éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 1000001ï¼‰';
        errorDiv.style.display = 'block';
        return;
      }

      // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
      if (!checkRateLimit()) {
        errorDiv.textContent = 'ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        errorDiv.style.display = 'block';
        return;
      }

      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = 'æ¤œç´¢ä¸­â€¦';

      try {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

        const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postal}`, {
          signal: controller.signal,
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          }
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }

        const data = await res.json();
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼
        if (typeof data !== 'object' || data === null) {
          throw new Error('Invalid response format');
        }

        if (data.status === 200 && data.results && Array.isArray(data.results) && data.results.length > 0) {
          const r = data.results[0];
          
          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
          const prefecture = sanitizeInput(r.address1 || '');
          const city = sanitizeInput((r.address2 || '') + (r.address3 || ''));

          if (prefecture && city) {
            document.getElementById('prefecture').value = prefecture;
            document.getElementById('city').value = city;
            document.getElementById('address').focus();
            
            // æ¤œç´¢å›æ•°ã‚’è¨˜éŒ²
            addressSearchCount++;
            lastAddressSearchTime = Date.now();
            sessionStorage.setItem(STORAGE_KEYS.searchCount, addressSearchCount.toString());
            
            saveAddressToStorage();
          } else {
            throw new Error('Invalid address data');
          }
        } else {
          errorDiv.textContent = 'è©²å½“ã™ã‚‹ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚éƒµä¾¿ç•ªå·ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
          errorDiv.style.display = 'block';
        }
      } catch (e) {
        console.error('Address search error:', e);
        
        if (e.name === 'AbortError') {
          errorDiv.textContent = 'æ¤œç´¢ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else {
          errorDiv.textContent = 'ä½æ‰€æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        errorDiv.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateSecurityStatus() {
      const indicator = document.getElementById('securityIndicator');
      
      if (location.protocol === 'https:') {
        indicator.className = 'security-indicator secure';
        indicator.innerHTML = 'ğŸ”’ ã‚»ã‚­ãƒ¥ã‚¢æ¥ç¶š';
      } else {
        indicator.className = 'security-indicator warning';
        indicator.innerHTML = 'âš ï¸ éã‚»ã‚­ãƒ¥ã‚¢æ¥ç¶š';
      }
    }

    // LIFFåˆæœŸåŒ–ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
    document.addEventListener('DOMContentLoaded', function () {
      updateSecurityStatus();
      
      // æ¤œç´¢å›æ•°ã®åˆæœŸåŒ–
      const storedCount = parseInt(sessionStorage.getItem(STORAGE_KEYS.searchCount) || '0');
      addressSearchCount = storedCount;

      if (typeof liff === 'undefined') {
        console.error('LIFF SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        return;
      }

      liff.init({ liffId: '2008001634-M7wLd2zR' })
        .then(() => {
          console.log('LIFFåˆæœŸåŒ–æˆåŠŸ');
          if (!liff.isLoggedIn()) {
            try { 
              liff.login(); 
            } catch (e) { 
              console.warn('liff.login() å¤±æ•—', e); 
            }
          }
        })
        .catch((err) => console.error('LIFFåˆæœŸåŒ–å¤±æ•—', err));

      // ä¿å­˜ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadNameFromStorage();
      loadPhoneFromStorage();
      loadAddressFromStorage();

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // éƒµä¾¿ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      const pc = document.getElementById('postalCode');
      if (pc) {
        pc.addEventListener('keypress', (e) => { 
          if (e.key === 'Enter') {
            e.preventDefault();
            searchAddress(); 
          }
        });
        pc.addEventListener('input', (e) => { 
          e.target.value = sanitizeInput(e.target.value).replace(/[^\d]/g, '').slice(0, 7);
          saveAddressToStorage();
        });
      }

      // åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      const lastName = document.getElementById('lastName');
      const firstName = document.getElementById('firstName');
      [lastName, firstName].forEach(field => {
        if (field) {
          field.addEventListener('blur', saveNameToStorage);
          field.addEventListener('input', (e) => {
            e.target.value = sanitizeInput(e.target.value).slice(0, 50);
          });
        }
      });

      // é›»è©±ç•ªå·ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      const phone = document.getElementById('phone');
      if (phone) {
        phone.addEventListener('blur', savePhoneToStorage);
        phone.addEventListener('input', (e) => {
          e.target.value = sanitizeInput(e.target.value).replace(/[^\d]/g, '').slice(0, 15);
        });
      }

      // ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      const addressFields = ['prefecture', 'city', 'address', 'building'];
      addressFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('blur', saveAddressToStorage);
          field.addEventListener('input', (e) => {
            const maxLength = fieldId === 'prefecture' ? 10 : (fieldId === 'city' ? 50 : 100);
            e.target.value = sanitizeInput(e.target.value).slice(0, maxLength);
          });
        }
      });

      // æ³¨æ–‡å†…å®¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
      const orderDetails = document.getElementById('orderDetails');
      if (orderDetails) {
        orderDetails.addEventListener('input', (e) => {
          e.target.value = sanitizeInput(e.target.value).slice(0, 1000);
        });
      }
    }

    function selectPayment(el) {
      document.querySelectorAll('.one').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      el.classList.add('active');
      el.setAttribute('aria-pressed', 'true');
      paymentMethod = sanitizeInput(el.innerText.trim());
    }

    function selectDelivery(el) {
      document.querySelectorAll('.two').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      el.classList.add('active');
      el.setAttribute('aria-pressed', 'true');
      deliveryMethod = sanitizeInput(el.innerText.trim());
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    function submitForm() {
      try {
        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        saveNameToStorage();
        savePhoneToStorage();
        saveAddressToStorage();

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®åé›†ã¨æ¤œè¨¼
        const lastNameValidation = validateName(document.getElementById('lastName').value);
        const firstNameValidation = validateName(document.getElementById('firstName').value);
        const phoneValidation = validatePhone(document.getElementById('phone').value);
        const addressValidation = validateAddress(document.getElementById('address').value);

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        showFieldValidation('lastName', lastNameValidation);
        showFieldValidation('firstName', firstNameValidation);
        showFieldValidation('phone', phoneValidation);
        showFieldValidation('address', addressValidation);

        // å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
        if (!lastNameValidation.isValid) {
          alert('ãŠåå‰ï¼ˆå§“ï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          document.getElementById('lastName').focus();
          return;
        }

        if (!firstNameValidation.isValid) {
          alert('ãŠåå‰ï¼ˆåï¼‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          document.getElementById('firstName').focus();
          return;
        }

        if (!paymentMethod) {
          alert('ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (!deliveryMethod) {
          alert('ãŠå±Šã‘æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (!phoneValidation.isValid) {
          alert('é›»è©±ç•ªå·ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          document.getElementById('phone').focus();
          return;
        }

        const postalCode = sanitizeInput(document.getElementById('postalCode').value);
        const prefecture = sanitizeInput(document.getElementById('prefecture').value);
        const city = sanitizeInput(document.getElementById('city').value);

        if (!postalCode || !prefecture || !city || !addressValidation.isValid) {
          alert('ä½æ‰€æƒ…å ±ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰
        const formData = {
          lastName: lastNameValidation.value,
          firstName: firstNameValidation.value,
          orderDetails: sanitizeInput(document.getElementById('orderDetails').value) || 'è¨˜è¼‰ãªã—',
          paymentMethod,
          deliveryMethod,
          phone: phoneValidation.value,
          postalCode,
          prefecture,
          city,
          address: addressValidation.value,
          building: sanitizeInput(document.getElementById('building').value) || '',
          timestamp: new Date().toLocaleString('ja-JP')
        };

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ§‹ç¯‰ï¼ˆã‚µãƒ‹ã‚¿ã‚¤ã‚ºæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
        let messageText = 'â‰ªã”æ³¨æ–‡å†…å®¹â‰«\n' +
          'ã€ãŠåå‰ã€‘\n' + formData.lastName + ' ' + formData.firstName + '\n\n' +
          'ã€ã”æ³¨æ–‡å†…å®¹ã€‘\n' + formData.orderDetails + '\n\n' +
          'ã€ãŠæ”¯æ‰•ã„æ–¹æ³•ã€‘\n' + formData.paymentMethod + '\n\n' +
          'ã€ãŠå±Šã‘æ–¹æ³•ã€‘\n' + formData.deliveryMethod + '\n\n' +
          'ã€ãŠé›»è©±ç•ªå·ã€‘\n' + formData.phone + '\n\n' +
          'ã€ãŠå±Šã‘å…ˆä½æ‰€ã€‘\n' + 'ã€’' + formData.postalCode + '\n' +
          formData.prefecture + formData.city + '\n' +
          formData.address + '\n' + formData.building + '\n\n' +
          'ã€é€ä¿¡æ—¥æ™‚ã€‘\n' + formData.timestamp;

        // LIFFé€ä¿¡ãƒã‚§ãƒƒã‚¯
        if (typeof liff === 'undefined' || !liff.isApiAvailable || !liff.isApiAvailable('sendMessages')) {
          alert('LIFFãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãŒåˆ©ç”¨ã§ããªã„ç’°å¢ƒã§ã™ã€‚LINEå†…ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          return;
        }

        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèª
        if (!confirm('å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ã”æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\né€ä¿¡å¾Œã®å¤‰æ›´ã¯ã§ãã¾ã›ã‚“ã€‚')) {
          return;
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
        liff.sendMessages([{ type: 'text', text: messageText }])
          .then(() => { 
            alert('ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å†…å®¹ã‚’ç¢ºèªæ¬¡ç¬¬ã€ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚'); 
            // é€ä¿¡æˆåŠŸå¾Œã¯ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¯ãƒªã‚¢
            sessionStorage.clear();
            liff.closeWindow(); 
          })
          .catch((err) => { 
            console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¤±æ•—', err); 
            alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'); 
          });

      } catch (error) {
        console.error('Form submission error:', error);
        alert('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('beforeunload', function() {
      // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«æ©Ÿå¯†æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      try {
        const sensitiveFields = ['lastName', 'firstName', 'phone'];
        sensitiveFields.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) field.value = '';
        });
      } catch (e) {
        // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
      }
    });

    // CSPã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('securitypolicyviolation', function(e) {
      console.error('CSP Violation:', e.violatedDirective, e.blockedURI);
    });

  </script>
</body>
</html>
