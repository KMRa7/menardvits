<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- âœ… å¼·åŒ–ç‰ˆ CSPï¼šconnect-src ã« LIFF å¿…é ˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ  -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://static.line-scdn.net https://kit.fontawesome.com https://cdnjs.cloudflare.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://kit.fontawesome.com;
    font-src https://fonts.gstatic.com https://kit.fontawesome.com;
    connect-src 'self'
      https://zipcloud.ibsnet.co.jp
      https://api.line.me
      https://api-data.line.me
      https://access.line.me
      https://liff.line.me
      https://prod-web.liff.line-apps.com
      https://static.line-scdn.net;
    img-src 'self' data: https:;
    frame-ancestors 'none';
  ">
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-Frame-Options" content="DENY" />
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
  <title>ã”æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ </title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <style>
    /* â†ï¼ˆã‚ãªãŸã®CSSãã®ã¾ã¾ï¼‰çœç•¥ãªã—ã§OK */
    /* ã“ã“ã¯å…ƒã‚³ãƒ¼ãƒ‰ã®CSSã‚’ãã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„ï¼ˆæ”¹å¤‰ãªã—ï¼‰ */
  </style>

  <!-- âœ… http ã§æ¥ãŸã‚‰ https ã¸ï¼ˆNetlify ã§ã‚‚ä¸€å¿œä¿é™ºï¼‰ -->
  <script>
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      location.replace('https://' + location.host + location.pathname + location.search + location.hash);
    }
  </script>
</head>

<body>
  <div id="securityIndicator" class="security-indicator">ğŸ”’ èª­ã¿è¾¼ã¿ä¸­...</div>

  <nav class="side-nav" aria-label="ãƒšãƒ¼ã‚¸å†…ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
    <a href="#section-message" title="é€ä¿¡ã¸ç§»å‹•"><span aria-hidden>â‡©</span></a>
  </nav>

  <main class="container" role="main">
    <h1>ã”æ³¨æ–‡ãƒšãƒ¼ã‚¸</h1>

    <!-- â†ï¼ˆã‚ãªãŸã®HTMLãƒ•ã‚©ãƒ¼ãƒ æœ¬ä½“ã¯ãã®ã¾ã¾ï¼‰ -->
    <!-- ä»¥é™ã€ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ã¯å…ƒã®ã¾ã¾è²¼ã£ã¦ãã ã•ã„ï¼ˆçœç•¥ï¼‰ -->

    <!-- ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ï¼â€¦ã‚‚å…ƒã®ã¾ã¾ã§OK -->
    <button type="button" class="clear-data-btn" onclick="clearAllSavedData()">ä¿å­˜æ¸ˆã¿å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
    <div style="margin-top: 20px;"></div>
  </main>

  <div class="footer-cta">
    <button class="btn-accent" onclick="submitForm()" id="section-message">é€ä¿¡</button>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>

  <script>
    // ====== ã“ã“ã‹ã‚‰JSï¼ˆã‚ãªãŸã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ã§ãã‚‹é™ã‚Šãã®ã¾ã¾ï¼‰ ======
    let paymentMethod = '';
    let deliveryMethod = '';
    let addressSearchCount = 0;
    const MAX_ADDRESS_SEARCHES = 10;
    let lastAddressSearchTime = 0;
    const SEARCH_COOLDOWN = 2000;
    let liffReady = false;

    const LIFF_ID = '2007458512-xZR3av9K'; // â† ã‚ãªãŸã® liffId

    const STORAGE_KEYS = {
      name: 'orderForm:name',
      phone: 'orderForm:phone',
      address: 'orderForm:address',
      searchCount: 'orderForm:searchCount'
    };

    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/[<>\"'&]/g, '').replace(/[\x00-\x1f\x7f-\x9f]/g, '').trim();
    }

    function validateName(name) {
      const s = sanitizeInput(name);
      if (!s) return { isValid: false, message: 'åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      if (s.length > 50) return { isValid: false, message: 'åå‰ã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      if (!/^[ã-ã‚“ ã‚¡-ãƒ¶a-zA-Zä¸€-é¾¯ãƒ¼]+$/.test(s)) return { isValid: false, message: 'æœ‰åŠ¹ãªåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      return { isValid: true, value: s };
    }

    function validatePhone(phone) {
      const s = sanitizeInput(phone).replace(/[^\d]/g, '');
      if (!s) return { isValid: false, message: 'é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      if (!/^0\d{9,10}$/.test(s)) return { isValid: false, message: 'æœ‰åŠ¹ãªé›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 09012345678ï¼‰ã€‚' };
      return { isValid: true, value: s };
    }

    function validateAddress(address) {
      const s = sanitizeInput(address);
      if (!s) return { isValid: false, message: 'ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      if (s.length > 100) return { isValid: false, message: 'ä½æ‰€ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      return { isValid: true, value: s };
    }

    function saveToStorage(key, data) { try { sessionStorage.setItem(key, JSON.stringify(data)); } catch(e){} }
    function loadFromStorage(key) { try { const d = sessionStorage.getItem(key); return d ? JSON.parse(d) : null; } catch(e){ return null; } }

    function showFieldValidation(fieldId, v) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + 'Error');
      if (!field || !errorDiv) return;
      if (v.isValid) {
        field.classList.remove('field-invalid'); field.classList.add('field-valid'); errorDiv.style.display = 'none';
      } else {
        field.classList.remove('field-valid'); field.classList.add('field-invalid');
        errorDiv.textContent = v.message; errorDiv.style.display = 'block';
      }
    }

    function saveNameToStorage() {
      const lv = validateName(document.getElementById('lastName').value);
      const fv = validateName(document.getElementById('firstName').value);
      showFieldValidation('lastName', lv);
      showFieldValidation('firstName', fv);
      if (lv.isValid && fv.isValid) saveToStorage(STORAGE_KEYS.name, { lastName: lv.value, firstName: fv.value });
    }
    function savePhoneToStorage() {
      const pv = validatePhone(document.getElementById('phone').value);
      showFieldValidation('phone', pv);
      if (pv.isValid) saveToStorage(STORAGE_KEYS.phone, pv.value);
    }
    function saveAddressToStorage() {
      const data = {
        postalCode: sanitizeInput(document.getElementById('postalCode').value),
        prefecture: sanitizeInput(document.getElementById('prefecture').value),
        city: sanitizeInput(document.getElementById('city').value),
        address: sanitizeInput(document.getElementById('address').value),
        building: sanitizeInput(document.getElementById('building').value)
      };
      saveToStorage(STORAGE_KEYS.address, data);
    }

    function loadNameFromStorage(){ const d=loadFromStorage(STORAGE_KEYS.name); if(d){ lastName.value=d.lastName||''; firstName.value=d.firstName||''; } }
    function loadPhoneFromStorage(){ const d=loadFromStorage(STORAGE_KEYS.phone); if(d){ phone.value=d; } }
    function loadAddressFromStorage(){ const d=loadFromStorage(STORAGE_KEYS.address); if(d){ postalCode.value=d.postalCode||''; prefecture.value=d.prefecture||''; city.value=d.city||''; address.value=d.address||''; building.value=d.building||''; } }

    function clearAllSavedData(){
      if(confirm('ä¿å­˜ã•ã‚ŒãŸå…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç¾åœ¨ã®å…¥åŠ›å†…å®¹ã¯æ®‹ã‚Šã¾ã™ï¼‰')){
        Object.values(STORAGE_KEYS).forEach(k=>sessionStorage.removeItem(k));
        alert('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
      }
    }

    function checkRateLimit(){
      const now = Date.now();
      if (now - lastAddressSearchTime < SEARCH_COOLDOWN) return false;
      addressSearchCount = parseInt(loadFromStorage(STORAGE_KEYS.searchCount) || '0');
      if (addressSearchCount >= MAX_ADDRESS_SEARCHES) {
        document.getElementById('rateLimitNotice').style.display = 'block';
        return false;
      }
      return true;
    }

    async function searchAddress(){
      const postal = sanitizeInput(document.getElementById('postalCode').value).replace(/[^\d]/g,'');
      const errorDiv = document.getElementById('postalError');
      const btn = document.getElementById('searchBtn');
      errorDiv.style.display = 'none';
      document.getElementById('rateLimitNotice').style.display = 'none';

      if (postal.length !== 7) { errorDiv.textContent='7æ¡ã®éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 1000001ï¼‰'; errorDiv.style.display='block'; return; }
      if (!checkRateLimit()) { errorDiv.textContent='ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'; errorDiv.style.display='block'; return; }

      btn.disabled = true; const original = btn.textContent; btn.textContent='æ¤œç´¢ä¸­â€¦';
      try{
        const controller=new AbortController(); const t=setTimeout(()=>controller.abort(),10000);
        const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postal}`,{signal:controller.signal});
        clearTimeout(t);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if(data.status===200 && data.results && data.results.length>0){
          const r=data.results[0];
          const prefecture=sanitizeInput(r.address1||'');
          const city=sanitizeInput((r.address2||'')+(r.address3||''));
          if(prefecture && city){
            document.getElementById('prefecture').value=prefecture;
            document.getElementById('city').value=city;
            document.getElementById('address').focus();
            addressSearchCount++; lastAddressSearchTime=Date.now();
            saveToStorage(STORAGE_KEYS.searchCount, addressSearchCount.toString());
            saveAddressToStorage();
          } else { throw new Error('Invalid address data'); }
        } else {
          errorDiv.textContent='è©²å½“ã™ã‚‹ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚éƒµä¾¿ç•ªå·ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
          errorDiv.style.display='block';
        }
      } catch(e){
        console.error('Address search error:', e);
        errorDiv.textContent = (e.name==='AbortError') ? 'æ¤œç´¢ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚' : 'ä½æ‰€æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        errorDiv.style.display='block';
      } finally {
        btn.disabled=false; btn.textContent=original;
      }
    }

    function updateSecurityStatus(){
      const indicator = document.getElementById('securityIndicator');
      if (location.protocol === 'https:') { indicator.className='security-indicator secure'; indicator.innerHTML='ğŸ”’ ã‚»ã‚­ãƒ¥ã‚¢æ¥ç¶š'; }
      else { indicator.className='security-indicator warning'; indicator.innerHTML='âš ï¸ éã‚»ã‚­ãƒ¥ã‚¢æ¥ç¶š'; }
    }

    function setupEventListeners(){
      const pc=document.getElementById('postalCode');
      if(pc){
        pc.addEventListener('keypress',e=>{ if(e.key==='Enter'){ e.preventDefault(); searchAddress(); }});
        pc.addEventListener('input',e=>{ e.target.value=sanitizeInput(e.target.value).replace(/[^\d]/g,'').slice(0,7); saveAddressToStorage(); });
      }

      const lastName=document.getElementById('lastName');
      const firstName=document.getElementById('firstName');
      [lastName, firstName].forEach(f=>{
        if(f){
          f.addEventListener('blur', saveNameToStorage);
          f.addEventListener('input', e=>{ e.target.value=sanitizeInput(e.target.value).slice(0,50); });
        }
      });

      const phone=document.getElementById('phone');
      if(phone){
        phone.addEventListener('blur', savePhoneToStorage);
        phone.addEventListener('input', e=>{ e.target.value=sanitizeInput(e.target.value).replace(/[^\d]/g,'').slice(0,15); });
      }

      ['prefecture','city','address','building'].forEach(id=>{
        const field=document.getElementById(id);
        if(field){
          field.addEventListener('blur', saveAddressToStorage);
          field.addEventListener('input', e=>{
            const max = id==='prefecture'?10:(id==='city'?50:100);
            e.target.value=sanitizeInput(e.target.value).slice(0,max);
          });
        }
      });

      const orderDetails=document.getElementById('orderDetails');
      if(orderDetails){
        orderDetails.addEventListener('input', e=>{
          e.target.value=sanitizeInput(e.target.value).slice(0,1000);
        });
      }
    }

    function selectPayment(el){
      document.querySelectorAll('.one').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      el.classList.add('active'); el.setAttribute('aria-pressed','true');
      paymentMethod = sanitizeInput(el.innerText.trim());
    }
    function selectDelivery(el){
      document.querySelectorAll('.two').forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
      el.classList.add('active'); el.setAttribute('aria-pressed','true');
      deliveryMethod = sanitizeInput(el.innerText.trim());
    }

    // âœ… LIFFåˆæœŸåŒ–ï¼šå …ç‰¢ç‰ˆ
    async function initLiff(){
      if (typeof liff === 'undefined') {
        console.warn('LIFF SDK not loaded');
        return;
      }
      try{
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isInClient()) {
          const indicator=document.getElementById('securityIndicator');
          indicator.className='security-indicator warning';
          indicator.innerHTML='â„¹ï¸ LINEã‚¢ãƒ—ãƒªå†…ã§é–‹ãã¨é€ä¿¡ã§ãã¾ã™';
        } else if (!liff.isLoggedIn()){
          liff.login({ redirectUri: window.location.href });
          return; // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        }

        if (!liff.isApiAvailable('sendMessages')) {
          console.error('sendMessages not available. Check LIFF permissions (chat_message.write).');
        }

        liffReady = true;
        console.log('LIFF init OK');
      } catch(err){
        liffReady = false;
        console.error('LIFF init failed:', err);
        const indicator=document.getElementById('securityIndicator');
        indicator.className='security-indicator warning';
        indicator.innerHTML='âš ï¸ LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼';
        alert(
          'LIFFåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' +
          'ãƒ»liffId ã¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURLã®ä¸€è‡´\n' +
          'ãƒ»ãƒšãƒ¼ã‚¸ãŒ https ã§é…ä¿¡ã•ã‚Œã¦ã„ã‚‹ã‹\n' +
          'ãƒ»CSP(connect-src) ã®è¨±å¯å…ˆ\n' +
          'ãƒ»LIFFæ¨©é™ï¼ˆchat_message.writeï¼‰\n' +
          'ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nè©³ç´°: ' + (err?.message || String(err))
        );
      }
    }

    // âœ… é€ä¿¡ï¼šå¿…è¦ãªã‚‰å†åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹
    async function submitForm(){
      try{
        saveNameToStorage(); savePhoneToStorage(); saveAddressToStorage();

        const lv = validateName(document.getElementById('lastName').value);
        const fv = validateName(document.getElementById('firstName').value);
        const pv = validatePhone(document.getElementById('phone').value);
        const av = validateAddress(document.getElementById('address').value);

        showFieldValidation('lastName', lv);
        showFieldValidation('firstName', fv);
        showFieldValidation('phone', pv);
        showFieldValidation('address', av);

        if (typeof liff === 'undefined') { alert('LINEç’°å¢ƒã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼ˆLIFF SDKæœªèª­è¾¼ï¼‰ã€‚'); return; }
        if (!liffReady) {
          try { await liff.init({ liffId: LIFF_ID }); liffReady = true; }
          catch(e){ alert('åˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\nï¼ˆliffId/https/CSPè¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ï¼‰'); return; }
        }
        if (!liff.isInClient()) { alert('ã“ã®ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã¯LINEã‚¢ãƒ—ãƒªå†…ã§ã®ã¿å¯èƒ½ã§ã™ã€‚\nå…¬å¼LINEã®ãƒœã‚¿ãƒ³ï¼ˆLIFFï¼‰ã‹ã‚‰é–‹ã„ã¦ãã ã•ã„ã€‚'); return; }
        if (!liff.isLoggedIn()) { liff.login({ redirectUri: window.location.href }); return; }
        if (!liff.isApiAvailable('sendMessages')) { alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ©Ÿèƒ½ãŒæ¨©é™æœªè¨­å®šã§ã™ã€‚\nLIFFã®scopeã« chat_message.write ã‚’ä»˜ä¸ã—ã¦å†å…¬é–‹ã—ã¦ãã ã•ã„ã€‚'); return; }

        const postalCode = sanitizeInput(document.getElementById('postalCode').value);
        const prefecture = sanitizeInput(document.getElementById('prefecture').value);
        const city = sanitizeInput(document.getElementById('city').value);
        if (!postalCode || !prefecture || !city || !av.isValid) { alert('ä½æ‰€æƒ…å ±ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

        const formData = {
          lastName: lv.value,
          firstName: fv.value,
          orderDetails: sanitizeInput(document.getElementById('orderDetails').value) || 'è¨˜è¼‰ãªã—',
          paymentMethod, deliveryMethod,
          phone: pv.value,
          postalCode, prefecture, city,
          address: av.value,
          building: sanitizeInput(document.getElementById('building').value) || '',
          timestamp: new Date().toLocaleString('ja-JP')
        };

        let messageText =
          'â‰ªã”æ³¨æ–‡å†…å®¹â‰«\n' +
          'ã€ãŠåå‰ã€‘\n' + formData.lastName + ' ' + formData.firstName + '\n\n' +
          'ã€ã”æ³¨æ–‡å†…å®¹ã€‘\n' + formData.orderDetails + '\n\n' +
          'ã€ãŠæ”¯æ‰•ã„æ–¹æ³•ã€‘\n' + formData.paymentMethod + '\n\n' +
          'ã€ãŠå±Šã‘æ–¹æ³•ã€‘\n' + formData.deliveryMethod + '\n\n' +
          'ã€ãŠé›»è©±ç•ªå·ã€‘\n' + formData.phone + '\n\n' +
          'ã€ãŠå±Šã‘å…ˆä½æ‰€ã€‘\n' + 'ã€’' + formData.postalCode + '\n' +
          formData.prefecture + formData.city + '\n' +
          formData.address + '\n' + formData.building + '\n\n' +
          'ã€é€ä¿¡æ—¥æ™‚ã€‘\n' + formData.timestamp;

        if (!confirm('å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ã”æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ\n\né€ä¿¡å¾Œã®å¤‰æ›´ã¯ã§ãã¾ã›ã‚“ã€‚')) return;

        await liff.sendMessages([{ type: 'text', text: messageText }]);
        alert('ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å†…å®¹ã‚’ç¢ºèªæ¬¡ç¬¬ã€ã”é€£çµ¡ã„ãŸã—ã¾ã™ã€‚');
        sessionStorage.clear();
        liff.closeWindow();
      } catch (error){
        console.error('Form submission error:', error);
        alert('äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š' + (error && error.message ? error.message : 'è©³ç´°ä¸æ˜'));
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      updateSecurityStatus();
      addressSearchCount = parseInt(loadFromStorage(STORAGE_KEYS.searchCount) || '0');
      initLiff();                 // â† åˆæœŸåŒ–ã‚¹ã‚¿ãƒ¼ãƒˆ
      loadNameFromStorage();
      loadPhoneFromStorage();
      loadAddressFromStorage();
      setupEventListeners();
    });

    window.addEventListener('error', e=>console.error('Global error:', e.error));
    window.addEventListener('unhandledrejection', e=>console.error('Unhandled promise rejection:', e.reason));
  </script>
</body>
</html>
