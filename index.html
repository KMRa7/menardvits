<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ご注文フォーム</title>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    /* ===== Calm & Elegant Theme ===== */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
      --bg: #f6f6f6;
      --panel: #ffffff;
      --ink-900: #111827;
      --ink-700: #374151;
      --ink-500: #6b7280;
      --line: #e5e7eb;
      --accent-50: #fffbfc;
      --accent-100: #ffefef;
      --accent-200: #ffdddd;
      --accent-300: #f6c8c8;
      --accent-500: #df9b9b;
      --accent-600: #c57f7f;
      --shadow: 0 2px 10px rgba(17, 24, 39, 0.06);
      --shadow-lg: 0 8px 28px rgba(17, 24, 39, 0.08);
      --r-md: 12px;
      --r-lg: 16px;
      --ease: cubic-bezier(.2,.7,.2,1);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
      color: var(--ink-900);
      background: linear-gradient(180deg, var(--bg) 0%, #ffffff 100%);
      line-height: 1.7;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 32px 16px;
      display: grid;
      place-items: start center;
    }

    .container {
      width: min(720px, 100%);
      background: var(--panel);
      border: 1px solid var(--line);
      box-shadow: var(--shadow-lg);
      border-radius: var(--r-lg);
      padding: clamp(20px, 3vw, 32px);
      position: relative;
    }
    .container::before {
      content: "";
      position: absolute; inset: 0 0 auto 0; height: 6px;
      background: linear-gradient(90deg, var(--accent-200), var(--accent-300));
      border-radius: var(--r-lg) var(--r-lg) 0 0;
    }

    h1 { margin: 8px 0 20px; font-size: clamp(22px, 3.2vw, 28px); font-weight: 700; letter-spacing: .01em; color: var(--ink-700); }

    .section-header {
      display: block; margin: 28px 0 12px; padding: 12px 16px;
      font-weight: 600; font-size: 15px; color: var(--ink-700);
      background: linear-gradient(180deg, var(--accent-100), #fff);
      border: 1px solid var(--accent-200); border-radius: var(--r-md);
    }

    .chip { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--line); color: var(--ink-700); background: #fff; margin-right: 8px; }
    .chip.required { border-color: #ef4444; color: #ef4444; background: #fff5f5; }
    .chip.optional { color: var(--ink-500); }

    .info-text { margin: 8px 0 16px; padding: 12px 14px; background: var(--accent-50); border: 1px dashed var(--accent-200); border-radius: var(--r-md); color: var(--ink-700); font-size: 14px; }

    label.label { display: block; margin: 18px 0 8px; font-weight: 600; color: var(--ink-700); font-size: 14px; }

    input[type="text"], input[type="tel"], textarea {
      width: 100%; padding: 12px 14px; border: 1px solid var(--line); border-radius: var(--r-md);
      font-size: 16px; background: #fff; color: var(--ink-900);
      transition: border-color .2s var(--ease), box-shadow .2s var(--ease);
    }
    input:focus, textarea:focus { outline: none; border-color: var(--accent-500); box-shadow: 0 0 0 4px rgba(223, 155, 155, .18); }

    .grid-buttons { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); margin: 10px 0 14px; }

    .btn-option {
      appearance: none; cursor: pointer; padding: 12px 14px; min-height: 44px;
      background: #fff; border: 1px solid var(--line); border-radius: var(--r-md);
      font-size: 14px; font-weight: 600; color: var(--ink-700);
      display: inline-flex; align-items: center; justify-content: center; text-align: center;
      transition: transform .05s var(--ease), border-color .2s var(--ease), background .2s var(--ease), box-shadow .2s var(--ease);
    }
    .btn-option:hover { border-color: var(--accent-300); background: var(--accent-50); }
    .btn-option:active { transform: translateY(1px); }
    .btn-option.active { border-color: var(--accent-500); background: var(--accent-100); box-shadow: inset 0 0 0 1px var(--accent-500); }

    .postal-input-container { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }

    .btn-accent {
      appearance: none; cursor: pointer; padding: 12px 16px; min-height: 44px; width: 100%;
      border: 1px solid var(--accent-500);
      background: linear-gradient(180deg, var(--accent-500), var(--accent-600));
      color: #fff; font-weight: 700; font-size: 16px; border-radius: var(--r-lg);
      box-shadow: var(--shadow); transition: transform .06s var(--ease), filter .2s var(--ease);
    }
    .btn-accent:hover { filter: brightness(1.02); }
    .btn-accent:active { transform: translateY(1px); }
    .btn-accent:disabled { opacity: .55; cursor: not-allowed; }

    .btn-subtle {
      appearance: none; cursor: pointer; padding: 12px 14px; min-height: 44px;
      border: 1px solid var(--line); background: #fff; color: var(--ink-700);
      border-radius: var(--r-md); font-weight: 600; font-size: 14px;
      transition: border-color .2s var(--ease), background .2s var(--ease);
    }
    .btn-subtle:hover { background: var(--accent-50); border-color: var(--accent-300); }

    .side-nav { position: fixed; right: 12px; top: 50%; transform: translateY(-50%); background: #fff; border: 1px solid var(--line); border-radius: 14px; padding: 8px; box-shadow: var(--shadow); }
    .side-nav a { display: grid; place-items: center; width: 44px; height: 44px; text-decoration: none; color: var(--ink-700); border-radius: 10px; font-size: 18px; }
    .side-nav a:hover { background: var(--accent-100); }

    .error-message { color: #b91c1c; font-size: 13px; margin-top: 6px; }
    .hidden { display: none !important; }

    @media (prefers-reduced-motion: reduce) { * { transition: none !重要; } }

    @media (max-width: 768px) {
      body { padding: 20px 12px; }
      .container { padding: 20px; }
      .side-nav { right: 8px; }
      .side-nav a { width: 40px; height: 40px; }
    }
    @media (max-width: 640px) {
      html, body { font-size: 16px; }
      body { padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) calc(84px + env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); }
      .container { border-radius: 14px; padding: 16px; }
      .grid-buttons { grid-template-columns: 1fr; }
      .side-nav { display: none; }
    }

    .footer-cta {
      position: fixed; left: 0; right: 0; bottom: 0;
      padding: 10px max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
      background: rgba(255,255,255,.85); backdrop-filter: saturate(140%) blur(10px);
      border-top: 1px solid var(--line); box-shadow: 0 -6px 24px rgba(17,24,39,.06); z-index: 50;
    }
    .footer-cta .btn-accent { width: 100%; }
    * { -webkit-tap-highlight-color: transparent; }
    .btn-option, .btn-subtle, .btn-accent { touch-action: manipulation; }

    .container::after { content: ""; display: block; height: 140px; }
  </style>
</head>

<body>
  <!-- 右側の追従ナビ（スマホはCSSで非表示） -->
  <nav class="side-nav" aria-label="ページ内ナビゲーション">
    <a href="#section-message" title="送信へ移動"><span aria-hidden>⇩</span></a>
  </nav>

  <main class="container" role="main">
    <h1>ご注文ページ</h1>

    <!-- お名前 -->
    <div class="section-header"><span class="chip required">必須</span>お名前をお願いします</div>
    <p class="info-text">お手数ですがお名前の記載をお願いいたします。（次回以降自動入力されます）</p>
    <label class="label" for="lastName">姓</label>
    <input type="text" id="lastName" placeholder="姓" autocomplete="family-name" />
    <label class="label" for="firstName">名</label>
    <input type="text" id="firstName" placeholder="名" autocomplete="given-name" />

    <!-- ご注文内容 -->
    <div class="section-header"><span class="chip optional">任意</span>ご注文の商品をご記入ください</div>
    <p class="info-text">・商品名、色番号<br />・数量<br />・その他ご不明な点があれば何でもどうぞ</p>
    <label class="label" for="orderDetails">ご注文内容</label>
    <textarea id="orderDetails" rows="4" placeholder="ご注文内容をご記入ください"></textarea>

    <!-- 支払い方法 -->
    <div class="section-header"><span class="chip required">必須</span>お支払い方法を選んでください</div>
    <div class="grid-buttons" role="group" aria-label="お支払い方法">
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">paypay</button>
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">銀行振込</button>
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">クレジットカード</button>
      <button type="button" class="btn-option one" onclick="selectPayment(this)" aria-pressed="false">店頭支払</button>
    </div>

    <!-- お届け方法 -->
    <div class="section-header"><span class="chip required">必須</span>お届け方法を選択してください</div>
    <div class="grid-buttons" role="group" aria-label="お届け方法">
      <button type="button" class="btn-option two" onclick="selectDelivery(this)" aria-pressed="false">宅配（送料無料）</button>
      <button type="button" class="btn-option two" onclick="selectDelivery(this)" aria-pressed="false">店頭受け取り</button>
    </div>

    <!-- お届け先情報（常時表示・保存対象） -->
    <section id="addressSection" aria-live="polite">
      <div class="section-header">
        <span class="chip optional">宅配選択時は必須</span>お届け先情報
      </div>
      <p class="info-text">次回以降、自動入力されます。店頭受け取りの方は未入力でも可です。</p>

      <label class="label">お電話番号</label>
      <input type="tel" id="phone" inputmode="tel" autocomplete="tel" placeholder="09012345678（ハイフンなし）">

      <label class="label" for="postalCode">郵便番号</label>
      <div class="postal-input-container">
        <input type="text" id="postalCode" inputmode="numeric" pattern="\d{7}" placeholder="例: 1000001（7桁・ハイフン不要）">
        <button type="button" class="btn-subtle" onclick="searchAddress()" id="searchBtn">住所検索</button>
      </div>
      <div class="error-message" id="postalError" style="display:none;"></div>

      <label class="label" for="prefecture">都道府県</label>
      <input type="text" id="prefecture" placeholder="都道府県" readonly />

      <label class="label" for="city">市区町村</label>
      <input type="text" id="city" placeholder="市区町村" readonly />

      <label class="label" for="address">番地</label>
      <input type="text" id="address" placeholder="番地を入力してください" />

      <label class="label" for="building">マンション・ビル名（任意）</label>
      <input type="text" id="building" placeholder="マンション・ビル名（任意）" />
    </section>

    <div style="margin-top: 20px;"></div>
  </main>

  <!-- 画面下部に固定の送信バー -->
  <div class="footer-cta">
    <button class="btn-accent" onclick="submitForm()" id="section-message" disabled>送信</button>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
  <script>
    let paymentMethod = '';
    let deliveryMethod = '';

    const NAME_KEY = 'orderForm:name';
    const ADDRESS_KEY = 'orderForm:address';

    // ===== ローカル保存：読込 =====
    function loadNameFromStorage() {
      try {
        const raw = localStorage.getItem(NAME_KEY);
        if (!raw) return;
        const { lastName, firstName } = JSON.parse(raw);
        if (lastName) document.getElementById('lastName').value = lastName;
        if (firstName) document.getElementById('firstName').value = firstName;
      } catch (e) { console.warn('名前の読込に失敗しました', e); }
    }
    function loadAddressFromStorage() {
      try {
        const raw = localStorage.getItem(ADDRESS_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);
        ['phone','postalCode','prefecture','city','address','building'].forEach(id => {
          if (obj[id]) document.getElementById(id).value = obj[id];
        });
      } catch (e) { console.warn('住所の読込に失敗しました', e); }
    }

    // ===== ローカル保存：保存 =====
    function saveNameToStorage() {
      try {
        const lastName = (document.getElementById('lastName').value || '').trim();
        const firstName = (document.getElementById('firstName').value || '').trim();
        if (!lastName && !firstName) { localStorage.removeItem(NAME_KEY); return; }
        localStorage.setItem(NAME_KEY, JSON.stringify({ lastName, firstName, savedAt: Date.now() }));
      } catch (e) { console.warn('名前の保存に失敗しました', e); }
    }
    function saveAddressToStorage() {
      try {
        const obj = {
          phone: (document.getElementById('phone').value || '').trim(),
          postalCode: (document.getElementById('postalCode').value || '').trim(),
          prefecture: (document.getElementById('prefecture').value || '').trim(),
          city: (document.getElementById('city').value || '').trim(),
          address: (document.getElementById('address').value || '').trim(),
          building: (document.getElementById('building').value || '').trim(),
          savedAt: Date.now()
        };
        const anyFilled = Object.values(obj).some(v => typeof v === 'string' ? v.length > 0 : false);
        if (!anyFilled) { localStorage.removeItem(ADDRESS_KEY); return; }
        localStorage.setItem(ADDRESS_KEY, JSON.stringify(obj));
      } catch (e) { console.warn('住所の保存に失敗しました', e); }
    }

    // ===== UI選択 =====
    function selectPayment(el) {
      document.querySelectorAll('.one').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
      el.classList.add('active'); el.setAttribute('aria-pressed', 'true');
      paymentMethod = el.innerText.trim();
    }
    function selectDelivery(el) {
      document.querySelectorAll('.two').forEach(b => { b.classList.remove('active'); b.setAttribute('aria-pressed', 'false'); });
      el.classList.add('active'); el.setAttribute('aria-pressed', 'true');
      deliveryMethod = el.innerText.trim();
    }

    // ===== 住所検索 =====
    async function searchAddress() {
      const postal = document.getElementById('postalCode').value.replace(/[^\d]/g, '');
      const errorDiv = document.getElementById('postalError');
      const btn = document.getElementById('searchBtn');

      errorDiv.style.display = 'none';
      if (postal.length !== 7) {
        errorDiv.textContent = '7桁の郵便番号を入力してください（例: 1000001）';
        errorDiv.style.display = 'block';
        return;
      }

      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = '検索中…';

      try {
        const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postal}`);
        const data = await res.json();
        if (data.status === 200 && data.results && data.results.length > 0) {
          const r = data.results[0];
          document.getElementById('prefecture').value = r.address1;
          document.getElementById('city').value = r.address2 + r.address3;
          document.getElementById('address').focus();
          saveAddressToStorage();
        } else {
          errorDiv.textContent = '該当する住所が見つかりませんでした。郵便番号をご確認ください。';
          errorDiv.style.display = 'block';
        }
      } catch (e) {
        console.error('住所検索エラー:', e);
        errorDiv.textContent = '住所検索でエラーが発生しました。時間をおいて再度お試しください。';
        errorDiv.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    }

    // ===== LIFF初期化＋準備フラグ =====
    window.__liffReady = false;

    async function initLiff() {
      if (typeof liff === 'undefined') {
        console.error('LIFF SDK が読み込まれていません。');
      } else {
        try {
          await liff.init({ liffId: '2008127424-G7Lwv7qD' });
          console.log('LIFF初期化成功');

          if (!liff.isLoggedIn()) {
            liff.login(); // リダイレクト
            return;
          }

          if (!liff.isInClient()) {
            console.log('外部ブラウザ表示。sendMessages不可→shareTargetPicker/コピーにフォールバック');
          }

          window.__liffReady = true;
        } catch (err) {
          console.error('LIFF初期化失敗', err);
        } finally {
          // 失敗しても必ずボタンを有効化（ユーザーを詰ませない）
          const btn = document.getElementById('section-message');
          if (btn) btn.disabled = false;
        }
      }
    }

    // ===== 初期化：入力イベント紐付け & ロード =====
    document.addEventListener('DOMContentLoaded', () => {
      initLiff();

      // 郵便番号：Enter検索 & 数値のみ
      const pc = document.getElementById('postalCode');
      if (pc) {
        pc.addEventListener('keypress', (e) => { if (e.key === 'Enter') searchAddress(); });
        pc.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^\d]/g, ''); saveAddressToStorage(); });
      }

      // 名前の自動保存
      const ln = document.getElementById('lastName');
      const fn = document.getElementById('firstName');
      ['change','input'].forEach(ev => {
        ln.addEventListener(ev, saveNameToStorage);
        fn.addEventListener(ev, saveNameToStorage);
      });

      // 住所系の自動保存
      ['phone','prefecture','city','address','building'].forEach(id => {
        const el = document.getElementById(id);
        if (el) ['change','input'].forEach(ev => el.addEventListener(ev, saveAddressToStorage));
      });

      // 既存保存値をロード
      loadNameFromStorage();
      loadAddressFromStorage();

      // 3秒経過時の保険（透明/タップ不可対策）
      setTimeout(() => {
        const btn = document.getElementById('section-message');
        if (btn && btn.disabled) {
          console.warn('LIFF未準備/失敗の可能性。フォールバックで送信ボタンを有効化します。');
          btn.disabled = false;
        }
      }, 3000);
    });

    function canSendViaChat() {
      try {
        if (typeof liff === 'undefined' || !liff.isInClient()) return false;
        const ctx = liff.getContext && liff.getContext();
        return ctx && ctx.type && ctx.type !== 'none'; // utou / room / group ならOK
      } catch (_) {
        return false;
      }
    }
    
    // ===== 送信 =====
    async function submitForm() {
      // LIFFの準備がなくても押せる設計。中でフォールバック分岐。
      saveNameToStorage();
      saveAddressToStorage();

      const formData = {
        lastName: document.getElementById('lastName').value.trim(),
        firstName: document.getElementById('firstName').value.trim(),
        orderDetails: document.getElementById('orderDetails').value.trim(),
        paymentMethod,
        deliveryMethod,
        phone: document.getElementById('phone')?.value.trim() || '',
        postalCode: document.getElementById('postalCode')?.value.trim() || '',
        prefecture: document.getElementById('prefecture')?.value.trim() || '',
        city: document.getElementById('city')?.value.trim() || '',
        address: document.getElementById('address')?.value.trim() || '',
        building: document.getElementById('building')?.value.trim() || ''
      };

      // 必須チェック
      if (!formData.lastName || !formData.firstName) { alert('お名前（姓・名）を入力してください。'); return; }
      if (!formData.paymentMethod) { alert('お支払い方法を選択してください。'); return; }
      if (!formData.deliveryMethod) { alert('お届け方法を選択してください。'); return; }

      // 宅配の場合のみ、住所＆電話を必須
      const isDelivery = formData.deliveryMethod.includes('宅配');
      if (isDelivery) {
        if (!formData.phone) { alert('宅配を選択された場合、電話番号は必須です。'); return; }
        if (!formData.postalCode || !formData.prefecture || !formData.city || !formData.address) {
          alert('宅配を選択された場合、住所情報（郵便番号・都道府県・市区町村・番地）は必須です。'); return;
        }
      }

      const messageText =
        '≪ご注文内容≫\n' +
        '【お名前】\n' + formData.lastName + ' ' + formData.firstName + '\n\n' +
        '【ご注文内容】\n' + (formData.orderDetails || '記載なし') + '\n\n' +
        '【お支払い方法】\n' + formData.paymentMethod + '\n\n' +
        '【お届け方法】\n' + formData.deliveryMethod + '\n\n' +
        (formData.phone || formData.postalCode || formData.prefecture || formData.city || formData.address || formData.building
          ? ('【お電話番号】\n' + (formData.phone || '記載なし') + '\n\n' +
             '【お届け先住所】\n' +
             (formData.postalCode ? ('〒' + formData.postalCode + '\n') : '') +
             (formData.prefecture || '') + (formData.city || '') + '\n' +
             (formData.address || '') + '\n' + (formData.building || '')
            )
          : ''
        );

      try {
        if (canSendViaChat()) {
          await liff.sendMessages([{ type: 'text', text: messageText }]);
          alert('ご注文ありがとうございます。内容を確認次第、ご連絡いたします。');
          liff.closeWindow();
          return;
        }
    
        // LINE内だがトーク外 / または外部ブラウザ → shareTargetPicker が使えればそちら
        if (typeof liff !== 'undefined' && liff.isApiAvailable && liff.isApiAvailable('shareTargetPicker')) {
          await liff.shareTargetPicker([{ type: 'text', text: messageText }]);
          alert('ご注文内容をLINEで共有しました。店舗側でも確認します。');
          return;
        }
    
        // 最終フォールバック：コピー
        await navigator.clipboard.writeText(messageText);
        alert('この画面はトーク外で開いています。トーク内のリッチメニューから開き直すか、コピーした内容をトークに貼り付けて送信してください。');
      } catch (err) {
        console.error('メッセージ送信失敗', err);
        alert('送信に失敗しました。LINEアプリ内のトークから開き直すか、再度お試しください。');
      }
    }
  </script>
</body>
</html>
